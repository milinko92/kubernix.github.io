<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pi-hole + Unbound DNS · Kubernix</title>
  <link rel="stylesheet" href="style.css?v=2" />
  <style>
    nav.primary { display:flex; gap:1rem; align-items:center; }
    nav.primary ul { list-style:none; margin:0; padding:0; display:flex; gap:1rem; }
    nav.primary li { position:relative; }
    nav.primary a { text-decoration:none; }
    nav.primary .dropdown { display:none; position:absolute; top:100%; left:0; min-width:220px; z-index:50; }
    nav.primary li:hover > .dropdown { display:block; }
    nav.primary .dropdown ul { display:block; background:var(--card-bg, #1f2329); border:1px solid var(--border, #2b3037); border-radius:12px; padding:.5rem; }
    nav.primary .dropdown li { padding:.25rem .5rem; white-space:nowrap; }
    nav.primary .dropdown li a { display:block; padding:.25rem .5rem; }
    .paper { border-radius:16px; padding:2rem; }
    pre { overflow:auto; padding:1rem; border-radius:12px; background:var(--code-bg, #111418); border:1px solid var(--border, #2b3037); }
    code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:0.95rem; }
    .muted { opacity:.85; }
    .kbd { padding:2px 6px; border:1px solid var(--border, #2b3037); border-radius:6px; background:var(--card-bg, #1f2329); font-family:inherit; font-size:0.9em; }
    .tagline { font-size:0.9rem; opacity:.8; }
    .back-btn { display:inline-block; margin-top:2rem; padding:0.6rem 1.2rem; background:#2b3037; color:#fff; border-radius:8px; text-decoration:none; }
    .back-btn:hover { background:#444b57; }
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div>
        <div class="brand"><a href="index.html" style="color:inherit;text-decoration:none;">Kubernix</a></div>
        <div class="tag">DevOps Journey · Homelab · Cloud</div>
      </div>
      <nav class="primary" aria-label="Primary">
        <ul>
          <li><a href="#top">Guide</a>
            <div class="dropdown" role="menu" aria-label="Guide sections">
              <ul>
                <li><a href="#introduction">Introduction</a></li>
                <li><a href="#hardware">Required Hardware</a></li>
                <li><a href="#software-install">Software Installation</a></li>
                <li><a href="#configuration">Configuration</a></li>
                <li><a href="#troubleshooting">Troubleshooting</a></li>
              </ul>
            </div>
          </li>
          <li><a href="#quick-commands">Quick Commands</a></li>
          <li><a href="#references">Resources</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="wrap" id="top">
    <article class="paper">
      <h1>Pi-hole + Unbound on Raspberry Pi 4 (Homelab Guide)</h1>
      <p class="tagline">Network-wide ad blocking with a validating, recursive, caching DNS resolver.</p>

      <h2 id="introduction">Introduction</h2>
      <p>
        This document walks through step-by-step installation of <strong>Pi-hole</strong> (DNS sinkhole and ad blocker)
        on a <strong>Raspberry Pi 4</strong>, together with <strong>Unbound</strong> as a local recursive and validating
        DNS resolver. This combination ensures privacy, speed, and reliability – without relying on external DNS providers.
      </p>

      <h2 id="hardware">Required Hardware</h2>
      <ul>
        <li>Raspberry Pi 4 (2–4 GB RAM recommended) + power supply</li>
        <li>microSD (≥ 16 GB, A1/A2 class recommended)</li>
        <li>Ethernet cable (more stable than Wi-Fi for DNS server)</li>
        <li>Case + cooling (optional)</li>
      </ul>

      <h2 id="software-install">Software Installation Steps</h2>
      <ol>
        <li><strong>Flash Raspberry Pi OS Lite (64‑bit)</strong> using Raspberry Pi Imager. Enable SSH and set a hostname.</li>
        <li><strong>First login and system update</strong>:
          <pre><code>sudo apt update && sudo apt full-upgrade -y
sudo reboot</code></pre></li>
        <li id="quick-commands"><strong>Set static IP address</strong> (example in <code>dhcpcd.conf</code>):
          <pre><code>sudo nano /etc/dhcpcd.conf

# Example (adjust to your network):
interface eth0
static ip_address=192.168.1.10/24
static routers=192.168.1.1
static domain_name_servers=127.0.0.1</code></pre>
          <p class="muted">Note: For LAN DNS clients, the DHCP gateway should advertise this Pi-hole server's IP.</p>
        </li>
        <li><strong>Install Pi-hole</strong> (official installer):
          <pre><code>curl -sSL https://install.pi-hole.net | bash</code></pre>
          <p>During installation, select the interface (<code>eth0</code>), static IP, and temporary upstream DNS (e.g., Quad9). We will later switch to Unbound.</p>
        </li>
        <li><strong>Install Unbound</strong>:
          <pre><code>sudo apt install -y unbound</code></pre></li>
        <li><strong>Download root hints</strong> (optional cron for monthly refresh):
          <pre><code>sudo mkdir -p /var/lib/unbound
sudo wget -O /var/lib/unbound/root.hints https://www.internic.net/domain/named.root
# (Optional) monthly auto-refresh:
echo '0 3 1 * * root wget -qO /var/lib/unbound/root.hints https://www.internic.net/domain/named.root' | sudo tee /etc/cron.d/unbound-root-hints</code></pre></li>
      </ol>

      <h2 id="configuration">Configuration Steps</h2>
      <ol>
        <li id="unbound-config"><strong>Unbound configuration</strong> – create dedicated file:
          <pre><code>sudo nano /etc/unbound/unbound.conf.d/pi-hole.conf</code></pre>
          <pre><code>server:
  verbosity: 0
  logfile: "/var/log/unbound/unbound.log"
  interface: 127.0.0.1
  port: 5335
  do-daemonize: no
  use-caps-for-id: no
  edns-buffer-size: 1232
  prefetch: yes
  qname-minimisation: yes
  harden-dnssec-stripped: yes
  harden-glue: yes
  harden-referral-path: yes
  aggressive-nsec: yes
  root-hints: "/var/lib/unbound/root.hints"
  cache-min-ttl: 3600
  cache-max-ttl: 86400
  msg-cache-size: 128m
  rrset-cache-size: 256m
  so-rcvbuf: 1m
  so-sndbuf: 1m
  access-control: 127.0.0.0/8 allow</code></pre>
          <p>Check config and start service:</p>
          <pre><code>sudo unbound-checkconf
sudo systemctl enable --now unbound</code></pre></li>
        <li><strong>Pi-hole → Upstream DNS = Unbound</strong>:
          <p>In <span class="kbd">http://&lt;IP-of-Pi&gt;/admin</span> → <em>Settings → DNS</em> enable <em>Custom 1 (IPv4)</em> and set:</p>
          <pre><code>127.0.0.1#5335</code></pre>
          <p>Disable all other external upstream options so queries go only through Unbound.</p></li>
        <li><strong>DNSSEC:</strong> With Unbound as validator, you usually do not enable DNSSEC inside Pi-hole (Unbound already validates).</li>
        <li><strong>Disable conflicting services on port 53 (if any):</strong>
          <pre><code>sudo systemctl disable --now systemd-resolved</code></pre></li>
      </ol>

      <h3 id="verify">Verification / Tests</h3>
      <pre><code># Query Unbound directly
dig @127.0.0.1 -p 5335 example.com +dnssec +multi

# Query via Pi-hole (port 53)
dig @127.0.0.1 example.com +dnssec +multi

# Test DNSSEC validation
dig @127.0.0.1 -p 5335 dnssec-failed.org A +dnssec
# Expect SERVFAIL (validation works)</code></pre>

      <h2 id="troubleshooting">Troubleshooting Tips</h2>
      <ul>
        <li><strong>Port 53 in use?</strong> Check: <code>sudo ss -tulpn | grep :53</code>. Stop or reconfigure the conflicting service.</li>
        <li><strong>Unbound not starting?</strong> Check logs: <code>sudo journalctl -u unbound -b</code>, and run <code>sudo unbound-checkconf</code>.</li>
        <li><strong>Slow resolution?</strong> Ensure <code>edns-buffer-size</code> ≤ 1232 and MTU settings are correct (try 1500/1492).</li>
        <li><strong>Pi-hole not blocking?</strong> Update gravity: <code>pihole -g</code> and confirm LAN clients use the Pi-hole IP as DNS.</li>
        <li><strong>DNSSEC problems?</strong> Test with <code>dnssec-failed.org</code>. If all queries fail, temporarily disable DNSSEC in Pi-hole (keep Unbound validating).</li>
        <li><strong>Outdated root hints?</strong> Refresh manually or via cron job as shown above.</li>
      </ul>

      <h2 id="references">Reference</h2>
      <p>
        Based on tutorial: 
        <a href="https://www.crosstalksolutions.com/the-worlds-greatest-pi-hole-and-unbound-tutorial-2023/" target="_blank" rel="noopener">
          Crosstalk Solutions — The World’s Greatest Pi-hole + Unbound Tutorial (2023)
        </a>.
      </p>

      <a href="index.html" class="back-btn">← Back to Index</a>

      <hr />
      <p class="muted">© 2025 Kubernix — Homelab Documentation. Prepared for Raspberry Pi 4 and Pi-hole + Unbound setup with focus on privacy and performance.</p>
    </article>
  </main>

  <footer>
    <div class="wrap" style="padding:0">
      <span>© 2025 Kubernix · <a href="https://kubernix.com">kubernix.com</a> · <a href="https://blog.kubernix.com">blog.kubernix.com</a></span>
    </div>
  </footer>
</body>
</html>
